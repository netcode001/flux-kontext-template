# Cursor Rules for Next.js 15 + TypeScript Project


 ç©·å°½ä¸€åˆ‡æ–¹æ³•æ€è€ƒï¼Œchatä¸Šä¸‹æ–‡ä¸­æ–‡Always respond in ä¸­æ–‡ï¼Œå¯¹è¯æ¡†è®¨è®ºæ°¸è¿œç”¨Chineseå›å¤æˆ‘ï¼Œ
 ä»£ç ä¸­åªèƒ½ç”¨ä¸­æ–‡æ³¨é‡Šä½†æ˜¯ç½‘é¡µæ–‡æ¡ˆä¸èƒ½æœ‰ä¸­æ–‡ï¼›æ°¸è¿œåªä½¿ç”¨3000ç«¯å£ä¸æ–°å¢ç«¯å£è¿è¡Œï¼Œ3000ç«¯å£ä¸€ç›´åœ¨å¯åŠ¨æ‰€ä»¥ä¸éœ€è¦æ–°å¢æœåŠ¡å™¨å¯åŠ¨ï¼Œ
 ä½ å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶æ¥æ£€æŸ¥å¹¶ä¿®æ”¹ç›´åˆ°é¡¹ç›®ä¸å†å‡ºç°é”™è¯¯ï¼Œæ¯æ¬¡é¡¹ç›®æ›´æ–°å’Œæ”¹åŠ¨ä¹Ÿéƒ½å†™åˆ°readme1.mdæ–‡æ¡£é‡Œé¢ï¼Œå¦‚æœ GitHub çš„é¡¹ç›®åœ°å€ä¸Šæ²¡æœ‰ readme1.mdï¼Œå°±æ–°å»ºä¸€ä¸ª readme1.md æ–‡æ¡£ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½ä¸€å®šè¦ä¸Šä¼ åˆ°GITçš„é»˜è®¤MASTERåˆ†æ”¯å¹¶å†™å¥½COMMIT MESSAGESä»¥æ”¾åœ¨ä»£ç æ”¹å´©æ–¹ä¾¿å¤‡ä»½æ¢å¤ï¼Œä¸è¦ç›´æ¥é—®æˆ‘è¦å¾ˆå¤šè§„åˆ™å’Œç­”æ¡ˆï¼Œè€Œæ˜¯å¸®æˆ‘è§„åˆ’å¥½ä¸åŒæ–¹æ¡ˆï¼Œä¸€æ­¥æ­¥æ’æŸ¥æ‰€æœ‰å¯èƒ½é—®é¢˜ï¼Œä½†æ˜¯ç»ä¸èƒ½æ“…è‡ªè½»æ˜“åˆ é™¤ä»»ä½•æ–‡ä»¶ï¼Œåˆ æ”¹æ–‡ä»¶å¿…é¡»åœ¨è·Ÿæˆ‘ç¡®è®¤ä¹‹åå†å»æ‰§è¡Œ
 ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½ä¸€å®šè¦ä¸Šä¼ åˆ°GITçš„é»˜è®¤MASTERåˆ†æ”¯å¹¶å†™å¥½COMMIT MESSAGESä»¥æ”¾åœ¨ä»£ç æ”¹å´©æ–¹ä¾¿å¤‡ä»½æ¢å¤ï¼Œä¸è¦ç›´æ¥é—®æˆ‘è¦å¾ˆå¤šè§„åˆ™å’Œç­”æ¡ˆï¼Œè€Œæ˜¯å¸®æˆ‘è§„åˆ’å¥½ä¸åŒæ–¹æ¡ˆï¼Œä¸€æ­¥æ­¥æ’æŸ¥æ‰€æœ‰å¯èƒ½é—®é¢˜ï¼Œä½†æ˜¯ç»ä¸èƒ½æ“…è‡ªè½»æ˜“åˆ é™¤ä»»ä½•æ–‡ä»¶ï¼Œåˆ æ”¹æ–‡ä»¶å¿…é¡»åœ¨è·Ÿæˆ‘ç¡®è®¤ä¹‹åå†å»æ‰§è¡Œ
ï¼Œé‡åˆ°éœ€è¦æˆ‘æä¾›ä¿¡æ¯çš„ä¸€å®šè¦è¯¢é—®æˆ‘ï¼ŒæŒ¨ä¸ªç»™æˆ‘è§£é‡Šä»£ç æ–‡ä»¶å’Œé€»è¾‘ç»“æ„ï¼Œä¸èƒ½åŸºäºä»»ä½•å‡è®¾æ¥åšä»£ç ä¿®æ”¹, å¿…é¡»æŸ¥çœ‹ä»£ç æ–‡ä»¶ç»“æ„å»ç¡®è®¤å®é™…æƒ…å†µ, æœ€åå†å»æ‰§è¡Œæ‰€æœ‰ä»£ç ä¿®æ”¹çš„åŠ¨ä½œï¼Œä¸€æ—¦å‡ºç°è§£å†³ä¸äº†çš„å¤æ‚é¡¹ç›®å°±æ‰“å°å‡½æ•°å’Œç¨‹åºè°ƒç”¨é“¾è‡ªå·±æ¥åˆ†æï¼šä¿®å¤ä¸‰å¾‹ï¼š1ï¸âƒ£ ç²¾ï¼šå¤æ‚åº¦â‰¤åŸæ–¹æ¡ˆ80%ï¼Œ2ï¸âƒ£ å‡†ï¼šç›´å‡»æ ¹æœ¬åŸå›  ï¼Œ3ï¸âƒ£ å‡€ï¼š0æŠ€æœ¯å€ºåŠ¡(SonarQubeâœ”ï¸)ï¼Œâš™ï¸ ä¸‰æ­¥èµ°ï¼šâ‘  æº¯æº â†’ å‡½æ•°ï¼Œæ–¹æ³•è°ƒç”¨é“¾â†’ é”™è¯¯è§¦å‘è·¯å¾„  â‘¡ æ‹†è§£ â†’ ç»™å‡º3ä¸ªSOLID++æ–¹æ¡ˆï¼Œä¸èƒ½åŸºäºä»»ä½•å‡è®¾å‰ææ¡ä»¶ï¼Œå¿…é¡»è¦è·Ÿæˆ‘ç¡®è®¤å…·ä½“çš„APIå’Œé¡¹ç›®æ–‡æ¡£ï¼Œä¸éœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨ï¼Œä¸€ç›´ä¿æŒ3000ç«¯å£æ‰“å¼€å³å¯ï¼Œåƒå°ç™½ä¸€æ ·æ•™å¯¼æˆ‘æ‰€æœ‰åŸºç¡€ç†è®ºçŸ¥è¯†ï¼Œ ç»ä¸èƒ½æ“…è‡ªè½»æ˜“åˆ é™¤ä»»ä½•æ–‡ä»¶ï¼Œåˆ æ”¹æ–‡ä»¶å¿…é¡»åœ¨è·Ÿæˆ‘ç¡®è®¤ä¹‹åå†å»æ‰§è¡Œï¼Œå…ˆä»”ç»†é˜…è¯»æ‰€æœ‰é¡¹ç›®æ–‡ä»¶æŸ¥çœ‹ç›¸å…³ä»£ç ææ¸…æ¥šæ‰€æœ‰æƒ…å†µå’Œé”™è¯¯é—®é¢˜æœ¬è´¨åŸå› å’Œå¯èƒ½è§£å†³æ–¹æ¡ˆå†è·Ÿæˆ‘ç¡®è®¤åå»åŠ¨æ‰‹åˆ æ”¹ä»£ç å“ˆ

æ³¨æ„é”™è¯¯ï¼šæ·»åŠ  "use client" æŒ‡ä»¤æ—¶ï¼Œä¸èƒ½åŒæ—¶å¯¼å‡º metadataï¼Œå› ä¸º metadata åªèƒ½åœ¨æœåŠ¡å™¨ç»„ä»¶ä¸­ä½¿ç”¨


  You are an expert in TypeScript, Node.js, Next.js App Router, React, Shadcn UI, Radix UI and Tailwind.
  
  Code Style and Structure
  - Write concise, technical TypeScript code with accurate examples.
  - Use functional and declarative programming patterns; avoid classes.
  - Prefer iteration and modularization over code duplication.
  - Use descriptive variable names with auxiliary verbs (e.g., isLoading, hasError).
  - Structure files: exported component, subcomponents, helpers, static content, types.
  
  Naming Conventions
  - Use lowercase with dashes for directories (e.g., components/auth-wizard).
  - Favor named exports for components.
  
  TypeScript Usage
  - Use TypeScript for all code; prefer interfaces over types.
  - Avoid enums; use maps instead.
  - Use functional components with TypeScript interfaces.
  
  Syntax and Formatting
  - Use the "function" keyword for pure functions.
  - Avoid unnecessary curly braces in conditionals; use concise syntax for simple statements.
  - Use declarative JSX.
  
  UI and Styling
  - Use Shadcn UI, Radix, and Tailwind for components and styling.
  - Implement responsive design with Tailwind CSS; use a mobile-first approach.
  
  Performance Optimization
  - Minimize 'use client', 'useEffect', and 'setState'; favor React Server Components (RSC).
  - Wrap client components in Suspense with fallback.
  - Use dynamic loading for non-critical components.
  - Optimize images: use WebP format, include size data, implement lazy loading.
  
  Key Conventions
  - Use 'nuqs' for URL search parameter state management.
  - Optimize Web Vitals (LCP, CLS, FID).
  - Limit 'use client':
    - Favor server components and Next.js SSR.
    - Use only for Web API access in small components.
    - Avoid for data fetching or state management.
  
  Follow Next.js docs for Data Fetching, Rendering, and Routing.    
  

## ğŸš¨ Critical Next.js Rules

### 1. "use client" vs metadata å†²çªè§„åˆ™
- âŒ **ç»å¯¹ç¦æ­¢**: åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­åŒæ—¶ä½¿ç”¨ `"use client"` å’Œ `export const metadata`
- âœ… **æ­£ç¡®åšæ³•**: 
  - æœåŠ¡å™¨ç»„ä»¶: åªå¤„ç† metadataï¼Œä¸ä½¿ç”¨ "use client"
  - å®¢æˆ·ç«¯ç»„ä»¶: åªå¤„ç†äº¤äº’é€»è¾‘ï¼Œä½¿ç”¨ "use client"
- ğŸ”§ **è§£å†³æ–¹æ¡ˆ**: é¡µé¢åˆ†ç¦»æ¶æ„
  ```typescript
  // âœ… æœåŠ¡å™¨ç»„ä»¶ (page.tsx)
  import type { Metadata } from 'next'
  import { PageContent } from '@/components/PageContent'
  
  export const metadata: Metadata = { /* SEOé…ç½® */ }
  export default function Page() {
    return <PageContent />
  }
  
  // âœ… å®¢æˆ·ç«¯ç»„ä»¶ (PageContent.tsx)
  "use client"
  import { useState } from "react"
  export function PageContent() {
    // æ‰€æœ‰äº¤äº’é€»è¾‘
  }
  ```

### 2. Next.js App Router æ¶æ„è§„åˆ™
- âœ… **layout.tsx**: åªèƒ½æ˜¯æœåŠ¡å™¨ç»„ä»¶ï¼Œå¤„ç†å…¨å±€é…ç½®
- âœ… **page.tsx**: ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨ç»„ä»¶ï¼Œéœ€è¦äº¤äº’æ—¶åˆ†ç¦»ä¸ºå®¢æˆ·ç«¯ç»„ä»¶
- âœ… **loading.tsx**: æœåŠ¡å™¨ç»„ä»¶ï¼Œå¤„ç†åŠ è½½çŠ¶æ€
- âœ… **error.tsx**: å¿…é¡»æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ ("use client")
- âœ… **not-found.tsx**: æœåŠ¡å™¨ç»„ä»¶

### 3. ç»„ä»¶å‘½åå’Œå¯¼å‡ºè§„åˆ™
- âœ… **é¡µé¢ç»„ä»¶**: ä½¿ç”¨ default export
- âœ… **å¯å¤ç”¨ç»„ä»¶**: ä½¿ç”¨ named export
- âœ… **å®¢æˆ·ç«¯ç»„ä»¶**: æ–‡ä»¶åä»¥ Content.tsx ç»“å°¾ (å¦‚ DashboardContent.tsx)
- âœ… **æœåŠ¡å™¨ç»„ä»¶**: ç›´æ¥ä½¿ç”¨ page.tsx æˆ–ç»„ä»¶å.tsx

### 4. TypeScript å’Œå¯¼å…¥è§„åˆ™
- âœ… **ç±»å‹å¯¼å…¥**: ä½¿ç”¨ `import type { Metadata } from 'next'`
- âœ… **ç»„ä»¶å¯¼å…¥**: ä½¿ç”¨ `import { Component } from '@/components/Component'`
- âœ… **é¿å…å¾ªç¯ä¾èµ–**: æ£€æŸ¥å¯¼å…¥è·¯å¾„ï¼Œé¿å… Aâ†’Bâ†’A çš„å¾ªç¯

### 5. çŠ¶æ€ç®¡ç†è§„åˆ™
- âœ… **useState/useEffect**: åªèƒ½åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨
- âœ… **usePathname/useRouter**: åªèƒ½åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨
- âœ… **æœåŠ¡å™¨ç»„ä»¶**: åªèƒ½ä½¿ç”¨ async/await å’ŒæœåŠ¡å™¨ç«¯ API

## ğŸ¯ å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: Event handlers in Server Components
```typescript
// âŒ é”™è¯¯
export default function Page() {
  return <button onClick={() => {}}>Click</button>
}

// âœ… æ­£ç¡®
"use client"
export function PageContent() {
  return <button onClick={() => {}}>Click</button>
}
```

### é”™è¯¯2: Hooks in Server Components
```typescript
// âŒ é”™è¯¯
export default function Page() {
  const [state, setState] = useState(false)
  return <div>{state}</div>
}

// âœ… æ­£ç¡®
"use client"
export function PageContent() {
  const [state, setState] = useState(false)
  return <div>{state}</div>
}
```

### é”™è¯¯3: Script onLoad in Server Components
```typescript
// âŒ é”™è¯¯
<Script src="..." onLoad={() => {}} />

// âœ… æ­£ç¡®
<Script src="..." strategy="lazyOnload" />
```

## ğŸ”§ ä»£ç è´¨é‡è§„åˆ™

### 1. ä¸­æ–‡æ³¨é‡Šè§„åˆ™
- âœ… **ä»£ç æ³¨é‡Š**: å¿…é¡»ä½¿ç”¨ä¸­æ–‡
- âœ… **ç½‘é¡µæ–‡æ¡ˆ**: å¿…é¡»ä½¿ç”¨è‹±æ–‡
- âœ… **å˜é‡å**: ä½¿ç”¨è‹±æ–‡
- âœ… **å‡½æ•°å**: ä½¿ç”¨è‹±æ–‡

### 2. ç«¯å£å’ŒæœåŠ¡å™¨è§„åˆ™
- âœ… **å›ºå®šç«¯å£**: æ°¸è¿œåªä½¿ç”¨ 3000 ç«¯å£
- âœ… **ä¸æ–°å¢ç«¯å£**: ä¸åˆ›å»ºæ–°çš„æœåŠ¡å™¨ç«¯å£
- âœ… **ä¿æŒè¿è¡Œ**: 3000 ç«¯å£ä¸€ç›´ä¿æŒå¯åŠ¨çŠ¶æ€

### 3. Git æäº¤è§„åˆ™
- âœ… **æ¯æ¬¡æ›´æ–°**: å¿…é¡»æäº¤åˆ° Git é»˜è®¤ master åˆ†æ”¯
- âœ… **Commit æ ¼å¼**: ä½¿ç”¨ä¸­æ–‡æè¿°å…·ä½“æ”¹åŠ¨
- âœ… **æ›´æ–°æ–‡æ¡£**: æ¯æ¬¡é¡¹ç›®æ›´æ–°éƒ½è¦æ›´æ–° README.md

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è§„åˆ™

### 1. ç»„ä»¶ä¼˜åŒ–
- âœ… **åŠ¨æ€å¯¼å…¥**: å¤§å‹ç»„ä»¶ä½¿ç”¨ `dynamic(() => import())`
- âœ… **Suspense**: å®¢æˆ·ç«¯ç»„ä»¶åŒ…è£…åœ¨ Suspense ä¸­
- âœ… **é¿å…è¿‡åº¦ä½¿ç”¨**: æœ€å°åŒ– "use client" çš„ä½¿ç”¨

### 2. å›¾ç‰‡ä¼˜åŒ–
- âœ… **Next.js Image**: ä½¿ç”¨ `next/image` ç»„ä»¶
- âœ… **WebPæ ¼å¼**: ä¼˜å…ˆä½¿ç”¨ WebP æ ¼å¼
- âœ… **æ‡’åŠ è½½**: å¯ç”¨å›¾ç‰‡æ‡’åŠ è½½

## ğŸ“ æ–‡æ¡£æ›´æ–°è§„åˆ™

### 1. README.md æ›´æ–°
- âœ… **åŠŸèƒ½å˜æ›´**: æ¯æ¬¡åŠŸèƒ½æ›´æ–°éƒ½è¦è®°å½•
- âœ… **æŠ€æœ¯å€ºåŠ¡**: è®°å½•å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- âœ… **ç‰ˆæœ¬ä¿¡æ¯**: æ›´æ–°ç‰ˆæœ¬å·å’Œæ›´æ–°æ—¥å¿—

### 2. é”™è¯¯å¤„ç†
- âœ… **ä¸‰å¾‹åŸåˆ™**: ç²¾(å¤æ‚åº¦â‰¤80%)ã€å‡†(ç›´å‡»æ ¹å› )ã€å‡€(0æŠ€æœ¯å€ºåŠ¡)
- âœ… **ä¸‰æ­¥èµ°**: æº¯æºâ†’æ‹†è§£â†’æ‰§è¡Œ
- âœ… **ä¸åŸºäºå‡è®¾**: å¿…é¡»æŸ¥çœ‹å®é™…ä»£ç æ–‡ä»¶ç¡®è®¤æƒ…å†µ 

# ğŸ›¡ï¸ Next.js 15 + TypeScript å®‰å…¨å¼€å‘è§„åˆ™
# åŸºäºR2å­˜å‚¨å®‰å…¨æ¼æ´æ•™è®­åˆ¶å®šçš„å…¨é¢å®‰å…¨å¼€å‘æ¸…å•

## ğŸ” æ ¸å¿ƒå®‰å…¨åŸåˆ™

### 1. æƒé™ä¼˜å…ˆåŸåˆ™ (Permission First)
- âŒ **ç»å¯¹ç¦æ­¢**: ä»»ä½•æ¶‰åŠèµ„æºæ“ä½œçš„APIéƒ½å¿…é¡»å…ˆéªŒè¯ç”¨æˆ·æƒé™
- âŒ **ç»å¯¹ç¦æ­¢**: å‰ç«¯ç»„ä»¶å‡è®¾ç”¨æˆ·å·²ç™»å½•è€Œä¸æ£€æŸ¥sessionçŠ¶æ€
- âœ… **å¿…é¡»éµå¾ª**: API-Firstå®‰å…¨éªŒè¯ï¼Œå‰ç«¯éªŒè¯ä»…ä½œä¸ºç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 2. æ·±åº¦é˜²å¾¡åŸåˆ™ (Defense in Depth)
- âœ… **å¤šå±‚éªŒè¯**: å‰ç«¯éªŒè¯ + APIéªŒè¯ + æ•°æ®åº“çº¦æŸ
- âœ… **å¤±è´¥å®‰å…¨**: éªŒè¯å¤±è´¥æ—¶æ‹’ç»æ“ä½œï¼Œè€Œä¸æ˜¯å…è®¸æ“ä½œ
- âœ… **æœ€å°æƒé™**: ç”¨æˆ·åªèƒ½è®¿é—®å…¶æœ‰æƒé™çš„èµ„æº

## ğŸ“¤ æ–‡ä»¶ä¸Šä¼ å®‰å…¨è§„åˆ™

### âš ï¸ é«˜é£é™©æ“ä½œæ£€æŸ¥æ¸…å•
```typescript
// âŒ å±é™©ç¤ºä¾‹ - ç›´æ¥ä¸Šä¼ æ— éªŒè¯
export async function POST(request: NextRequest) {
  const file = formData.get('file') as File
  await uploadToStorage(file) // ğŸš¨ å®‰å…¨æ¼æ´ï¼
}

// âœ… å®‰å…¨ç¤ºä¾‹ - å®Œæ•´éªŒè¯æµç¨‹
export async function POST(request: NextRequest) {
  // 1. ğŸ” ç”¨æˆ·è®¤è¯éªŒè¯
  const session = await getServerSession(authOptions)
  if (!session?.user) {
    return NextResponse.json({ error: 'è¯·å…ˆç™»å½•' }, { status: 401 })
  }
  
  // 2. ğŸ›¡ï¸ æ–‡ä»¶ç±»å‹éªŒè¯
  const file = formData.get('file') as File
  if (!ALLOWED_FILE_TYPES.includes(file.type)) {
    return NextResponse.json({ error: 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹' }, { status: 400 })
  }
  
  // 3. ğŸ“ æ–‡ä»¶å¤§å°éªŒè¯
  if (file.size > MAX_FILE_SIZE) {
    return NextResponse.json({ error: 'æ–‡ä»¶è¿‡å¤§' }, { status: 400 })
  }
  
  // 4. ğŸ” å†…å®¹å®‰å…¨æ£€æŸ¥
  const isContentSafe = await validateFileContent(file)
  if (!isContentSafe) {
    return NextResponse.json({ error: 'æ–‡ä»¶å†…å®¹ä¸åˆè§„' }, { status: 400 })
  }
  
  // 5. ğŸ“Š ç”¨æˆ·é…é¢æ£€æŸ¥
  const canUpload = await checkUserUploadQuota(session.user.id)
  if (!canUpload) {
    return NextResponse.json({ error: 'ä¸Šä¼ é…é¢å·²ç”¨å®Œ' }, { status: 429 })
  }
  
  // 6. ğŸ’¾ æ‰§è¡Œä¸Šä¼ æ“ä½œ
  const result = await uploadToStorage(file, session.user.id)
  return NextResponse.json({ success: true, data: result })
}
```

### ğŸ“‹ æ–‡ä»¶ä¸Šä¼ å¿…å¤‡éªŒè¯æ¸…å•
- [ ] âœ… ç”¨æˆ·ç™»å½•çŠ¶æ€éªŒè¯ (`getServerSession`)
- [ ] âœ… æ–‡ä»¶ç±»å‹ç™½åå•éªŒè¯ (`ALLOWED_FILE_TYPES`)
- [ ] âœ… æ–‡ä»¶å¤§å°é™åˆ¶éªŒè¯ (`MAX_FILE_SIZE`)
- [ ] âœ… æ–‡ä»¶å†…å®¹å®‰å…¨æ‰«æ (`validateFileContent`)
- [ ] âœ… ç”¨æˆ·ä¸Šä¼ é…é¢æ£€æŸ¥ (`checkUserUploadQuota`)
- [ ] âœ… æ–‡ä»¶å‘½åå’Œè·¯å¾„å®‰å…¨ (`sanitizeFileName`)
- [ ] âœ… ä¸Šä¼ è®°å½•å®¡è®¡æ—¥å¿— (`logUploadActivity`)

## ğŸ”‘ APIæƒé™éªŒè¯è§„åˆ™

### ğŸš¨ å¼ºåˆ¶å®‰å…¨æ£€æŸ¥
```typescript
// æ¯ä¸ªAPIè·¯ç”±éƒ½å¿…é¡»åŒ…å«çš„å®‰å…¨æ£€æŸ¥æ¨¡æ¿
export async function POST/GET/PUT/DELETE(request: NextRequest) {
  try {
    // ğŸ” ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·è®¤è¯
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return unauthorizedResponse('ç”¨æˆ·æœªç™»å½•')
    }
    
    // ğŸ›¡ï¸ ç¬¬äºŒæ­¥ï¼šæƒé™æˆæƒ
    const hasPermission = await checkUserPermission(session.user.id, 'required_permission')
    if (!hasPermission) {
      return forbiddenResponse('æƒé™ä¸è¶³')
    }
    
    // ğŸ“ ç¬¬ä¸‰æ­¥ï¼šè¾“å…¥éªŒè¯
    const validation = await validateRequestData(request)
    if (!validation.success) {
      return badRequestResponse(validation.errors)
    }
    
    // ğŸ” ç¬¬å››æ­¥ï¼šèµ„æºæƒé™æ£€æŸ¥ï¼ˆå¦‚æœæ“ä½œç‰¹å®šèµ„æºï¼‰
    if (resourceId) {
      const canAccessResource = await checkResourcePermission(session.user.id, resourceId)
      if (!canAccessResource) {
        return forbiddenResponse('æ— æƒè®¿é—®è¯¥èµ„æº')
      }
    }
    
    // âœ… æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    const result = await businessLogic(validatedData)
    
    // ğŸ“Š è®°å½•æ“ä½œæ—¥å¿—
    await logUserActivity(session.user.id, 'operation_type', { resourceId, result })
    
    return successResponse(result)
    
  } catch (error) {
    // ğŸš¨ é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
    await logError('API_ERROR', error, { userId: session?.user?.id, endpoint: request.url })
    return internalErrorResponse('æ“ä½œå¤±è´¥')
  }
}
```

### ğŸ“‹ APIå®‰å…¨éªŒè¯æ¸…å•
- [ ] âœ… ç”¨æˆ·è®¤è¯éªŒè¯ (`getServerSession`)
- [ ] âœ… æƒé™æˆæƒæ£€æŸ¥ (`checkUserPermission`)
- [ ] âœ… è¾“å…¥æ•°æ®éªŒè¯ (`validateRequestData`)
- [ ] âœ… èµ„æºæƒé™éªŒè¯ (`checkResourcePermission`)
- [ ] âœ… é€Ÿç‡é™åˆ¶æ£€æŸ¥ (`rateLimitCheck`)
- [ ] âœ… CSRFä¿æŠ¤éªŒè¯ (`csrfProtection`)
- [ ] âœ… æ“ä½œå®¡è®¡æ—¥å¿— (`logUserActivity`)
- [ ] âœ… é”™è¯¯å¤„ç†æ—¥å¿— (`logError`)

## ğŸ¨ å‰ç«¯ç»„ä»¶å®‰å…¨è§„åˆ™

### ğŸ” ç»„ä»¶æƒé™æ£€æŸ¥æ¨¡æ¿
```typescript
export function SecureComponent({ onAction }: Props) {
  const { data: session, status } = useSession()
  
  // ğŸ”„ åŠ è½½çŠ¶æ€å¤„ç†
  if (status === 'loading') {
    return <LoadingState />
  }
  
  // ğŸ” æœªç™»å½•çŠ¶æ€å¤„ç†
  if (!session) {
    return <LoginPromptUI />
  }
  
  // ğŸ›¡ï¸ æƒé™æ£€æŸ¥
  const hasPermission = useUserPermission('required_permission')
  if (!hasPermission) {
    return <InsufficientPermissionUI />
  }
  
  // âœ… æ­£å¸¸ç»„ä»¶æ¸²æŸ“
  return <AuthorizedComponent onAction={onAction} />
}
```

### ğŸ“‹ å‰ç«¯å®‰å…¨æ£€æŸ¥æ¸…å•
- [ ] âœ… SessionçŠ¶æ€æ£€æŸ¥ (`useSession`)
- [ ] âœ… åŠ è½½çŠ¶æ€å¤„ç† (`status === 'loading'`)
- [ ] âœ… æœªç™»å½•UIå±•ç¤º (`LoginPromptUI`)
- [ ] âœ… æƒé™çŠ¶æ€æ£€æŸ¥ (`useUserPermission`)
- [ ] âœ… æƒé™ä¸è¶³UIå±•ç¤º (`InsufficientPermissionUI`)
- [ ] âœ… æ•æ„Ÿæ“ä½œäºŒæ¬¡ç¡®è®¤ (`confirmAction`)
- [ ] âœ… å®¢æˆ·ç«¯æ•°æ®éªŒè¯ (`validateClientData`)

## ğŸ—„ï¸ æ•°æ®åº“æ“ä½œå®‰å…¨è§„åˆ™

### ğŸ”’ æ•°æ®åº“å®‰å…¨æ¨¡æ¿
```typescript
// âœ… å®‰å…¨çš„æ•°æ®åº“æ“ä½œç¤ºä¾‹
export async function createPost(userId: string, postData: PostData) {
  // ğŸ” ç”¨æˆ·æƒé™éªŒè¯
  const user = await getUserById(userId)
  if (!user || user.status !== 'active') {
    throw new UnauthorizedError('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸')
  }
  
  // ğŸ›¡ï¸ æ•°æ®éªŒè¯å’Œæ¸…ç†
  const validatedData = await validateAndSanitizePostData(postData)
  
  // ğŸ“Š é…é¢æ£€æŸ¥
  const canCreatePost = await checkUserPostQuota(userId)
  if (!canCreatePost) {
    throw new QuotaExceededError('å‘å¸ƒé…é¢å·²ç”¨å®Œ')
  }
  
  // ğŸ’¾ äº‹åŠ¡æ€§æ“ä½œ
  return await db.transaction(async (tx) => {
    const post = await tx.posts.create({
      data: {
        ...validatedData,
        userId,
        createdAt: new Date(),
        status: 'pending_review' // é»˜è®¤éœ€è¦å®¡æ ¸
      }
    })
    
    // ğŸ“ˆ æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
    await tx.users.update({
      where: { id: userId },
      data: { postsCount: { increment: 1 } }
    })
    
    return post
  })
}
```

### ğŸ“‹ æ•°æ®åº“å®‰å…¨æ¸…å•
- [ ] âœ… ç”¨æˆ·çŠ¶æ€éªŒè¯ (`user.status === 'active'`)
- [ ] âœ… æ•°æ®è¾“å…¥éªŒè¯ (`validateAndSanitizeData`)
- [ ] âœ… SQLæ³¨å…¥é˜²æŠ¤ (`parameterized queries`)
- [ ] âœ… è¡Œçº§æƒé™æ§åˆ¶ (`Row Level Security`)
- [ ] âœ… äº‹åŠ¡æ“ä½œä¿è¯ (`db.transaction`)
- [ ] âœ… è½¯åˆ é™¤ç­–ç•¥ (`deleted_at` instead of DELETE)
- [ ] âœ… å®¡è®¡è·Ÿè¸ªè®°å½• (`audit_log`)

## ğŸ”§ ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆå®‰å…¨è§„åˆ™

### ğŸŒ å¤–éƒ¨æœåŠ¡å®‰å…¨æ¨¡æ¿
```typescript
// âœ… å®‰å…¨çš„ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨
export class SecureExternalService {
  private async callExternalAPI(userId: string, data: any) {
    // ğŸ” ç”¨æˆ·æƒé™éªŒè¯
    const hasPermission = await this.checkUserPermission(userId, 'external_api_access')
    if (!hasPermission) {
      throw new UnauthorizedError('æ— æƒè®¿é—®å¤–éƒ¨æœåŠ¡')
    }
    
    // ğŸ“Š é…é¢æ£€æŸ¥
    const canMakeRequest = await this.checkAPIQuota(userId)
    if (!canMakeRequest) {
      throw new QuotaExceededError('APIè°ƒç”¨é…é¢å·²ç”¨å®Œ')
    }
    
    // ğŸ›¡ï¸ æ•°æ®æ¸…ç†å’ŒéªŒè¯
    const sanitizedData = await this.sanitizeExternalData(data)
    
    // ğŸ” æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
    const filteredData = await this.filterSensitiveInfo(sanitizedData)
    
    try {
      // ğŸ“¡ å¤–éƒ¨APIè°ƒç”¨
      const response = await this.makeAPICall(filteredData)
      
      // ğŸ“Š è®°å½•ä½¿ç”¨æ—¥å¿—
      await this.logAPIUsage(userId, 'external_service', response.status)
      
      return response
    } catch (error) {
      // ğŸš¨ é”™è¯¯æ—¥å¿—è®°å½•
      await this.logAPIError(userId, 'external_service', error)
      throw error
    }
  }
}
```

### ğŸ“‹ ç¬¬ä¸‰æ–¹æœåŠ¡å®‰å…¨æ¸…å•
- [ ] âœ… APIè®¿é—®æƒé™éªŒè¯ (`checkUserPermission`)
- [ ] âœ… APIè°ƒç”¨é…é¢é™åˆ¶ (`checkAPIQuota`)
- [ ] âœ… æ•æ„Ÿæ•°æ®è¿‡æ»¤ (`filterSensitiveInfo`)
- [ ] âœ… é”™è¯¯ä¿¡æ¯è„±æ• (`sanitizeErrorMessage`)
- [ ] âœ… é‡è¯•æœºåˆ¶å®ç° (`retryWithBackoff`)
- [ ] âœ… è¶…æ—¶æ§åˆ¶è®¾ç½® (`requestTimeout`)
- [ ] âœ… ä½¿ç”¨æ—¥å¿—è®°å½• (`logAPIUsage`)

## ğŸš¨ é”™è¯¯å¤„ç†å’Œæ—¥å¿—å®‰å…¨è§„åˆ™

### ğŸ“ å®‰å…¨æ—¥å¿—è®°å½•æ¨¡æ¿
```typescript
// âœ… å®‰å…¨çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
export class SecurityLogger {
  // ğŸ” æ•æ„Ÿæ“ä½œæ—¥å¿—
  static async logSecurityEvent(
    eventType: 'LOGIN_ATTEMPT' | 'PERMISSION_DENIED' | 'SUSPICIOUS_ACTIVITY',
    userId: string | null,
    details: Record<string, any>,
    request?: NextRequest
  ) {
    const logData = {
      timestamp: new Date().toISOString(),
      eventType,
      userId,
      ip: this.getClientIP(request),
      userAgent: request?.headers.get('user-agent'),
      details: this.sanitizeLogData(details),
      severity: this.getEventSeverity(eventType)
    }
    
    // ğŸ“Š å†™å…¥å®‰å…¨æ—¥å¿—
    await this.writeSecurityLog(logData)
    
    // ğŸš¨ é«˜é£é™©äº‹ä»¶å‘Šè­¦
    if (logData.severity === 'HIGH') {
      await this.sendSecurityAlert(logData)
    }
  }
  
  // ğŸ›¡ï¸ é”™è¯¯ä¿¡æ¯è„±æ•
  static sanitizeErrorForUser(error: Error): string {
    // ä¸å‘ç”¨æˆ·æš´éœ²å†…éƒ¨é”™è¯¯è¯¦æƒ…
    const safeErrors = [
      'ValidationError',
      'UnauthorizedError',
      'ForbiddenError',
      'NotFoundError'
    ]
    
    if (safeErrors.includes(error.constructor.name)) {
      return error.message
    }
    
    return 'ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•'
  }
}
```

### ğŸ“‹ é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ¸…å•
- [ ] âœ… æ•æ„Ÿæ“ä½œæ—¥å¿—è®°å½• (`logSecurityEvent`)
- [ ] âœ… é”™è¯¯ä¿¡æ¯ç”¨æˆ·è„±æ• (`sanitizeErrorForUser`)
- [ ] âœ… é«˜é£é™©äº‹ä»¶å‘Šè­¦ (`sendSecurityAlert`)
- [ ] âœ… ç”¨æˆ·IPåœ°å€è®°å½• (`getClientIP`)
- [ ] âœ… è¯·æ±‚æŒ‡çº¹è®°å½• (`generateRequestFingerprint`)
- [ ] âœ… æ—¥å¿—æ•°æ®è„±æ• (`sanitizeLogData`)
- [ ] âœ… å®¡è®¡è·Ÿè¸ªå®Œæ•´æ€§ (`auditTrail`)

## ğŸ§ª å®‰å…¨æµ‹è¯•è§„åˆ™

### âœ… å¼ºåˆ¶å®‰å…¨æµ‹è¯•æ¸…å•
```typescript
// æ¯ä¸ªæ¶‰åŠæƒé™çš„åŠŸèƒ½éƒ½å¿…é¡»åŒ…å«çš„æµ‹è¯•ç”¨ä¾‹
describe('Security Tests', () => {
  // ğŸ” è®¤è¯æµ‹è¯•
  test('should reject unauthenticated requests', async () => {
    const response = await request(app)
      .post('/api/secure-endpoint')
      .send(validData)
    
    expect(response.status).toBe(401)
    expect(response.body.error).toContain('ç™»å½•')
  })
  
  // ğŸ›¡ï¸ æˆæƒæµ‹è¯•
  test('should reject unauthorized users', async () => {
    const response = await request(app)
      .post('/api/admin-endpoint')
      .set('Authorization', `Bearer ${regularUserToken}`)
      .send(validData)
    
    expect(response.status).toBe(403)
    expect(response.body.error).toContain('æƒé™')
  })
  
  // ğŸ“ è¾“å…¥éªŒè¯æµ‹è¯•
  test('should validate malicious input', async () => {
    const maliciousData = {
      title: '<script>alert("xss")</script>',
      content: 'DROP TABLE users;'
    }
    
    const response = await request(app)
      .post('/api/posts')
      .set('Authorization', `Bearer ${validToken}`)
      .send(maliciousData)
    
    expect(response.status).toBe(400)
    expect(response.body.error).toContain('è¾“å…¥éªŒè¯å¤±è´¥')
  })
  
  // ğŸ“Š é…é¢æµ‹è¯•
  test('should enforce rate limits', async () => {
    // å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚
    const promises = Array(10).fill(null).map(() =>
      request(app)
        .post('/api/upload')
        .set('Authorization', `Bearer ${validToken}`)
        .attach('file', Buffer.from('test'), 'test.jpg')
    )
    
    const responses = await Promise.all(promises)
    const tooManyRequests = responses.filter(r => r.status === 429)
    
    expect(tooManyRequests.length).toBeGreaterThan(0)
  })
})
```

### ğŸ“‹ å®‰å…¨æµ‹è¯•æ£€æŸ¥æ¸…å•
- [ ] âœ… æœªè®¤è¯è¯·æ±‚æ‹’ç»æµ‹è¯• (`401 tests`)
- [ ] âœ… æœªæˆæƒè®¿é—®æ‹’ç»æµ‹è¯• (`403 tests`)
- [ ] âœ… è¾“å…¥éªŒè¯å®‰å…¨æµ‹è¯• (`XSS/SQL injection tests`)
- [ ] âœ… æ–‡ä»¶ä¸Šä¼ å®‰å…¨æµ‹è¯• (`malicious file tests`)
- [ ] âœ… é€Ÿç‡é™åˆ¶æµ‹è¯• (`rate limit tests`)
- [ ] âœ… æƒé™è¾¹ç•Œæµ‹è¯• (`permission boundary tests`)
- [ ] âœ… æ•°æ®æ³„éœ²æµ‹è¯• (`data exposure tests`)

## ğŸ“‹ ä»£ç å®¡æŸ¥å®‰å…¨æ£€æŸ¥æ¸…å•

### ğŸ” Pull Request å¿…å¤‡å®‰å…¨å®¡æŸ¥é¡¹ç›®
- [ ] âœ… æ‰€æœ‰APIéƒ½åŒ…å«ç”¨æˆ·è®¤è¯æ£€æŸ¥
- [ ] âœ… æ•æ„Ÿæ“ä½œéƒ½åŒ…å«æƒé™éªŒè¯
- [ ] âœ… æ–‡ä»¶ä¸Šä¼ éƒ½åŒ…å«å®‰å…¨éªŒè¯
- [ ] âœ… æ•°æ®åº“æ“ä½œéƒ½ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- [ ] âœ… ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯å’Œæ¸…ç†
- [ ] âœ… é”™è¯¯ä¿¡æ¯ä¸æš´éœ²æ•æ„Ÿæ•°æ®
- [ ] âœ… æ—¥å¿—è®°å½•åŒ…å«å¿…è¦çš„å®‰å…¨ä¿¡æ¯
- [ ] âœ… ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨åŒ…å«é…é¢é™åˆ¶
- [ ] âœ… å‰ç«¯ç»„ä»¶åŒ…å«æƒé™çŠ¶æ€æ£€æŸ¥
- [ ] âœ… å®‰å…¨æµ‹è¯•è¦†ç›–æ‰€æœ‰æƒé™åœºæ™¯

## ğŸš€ éƒ¨ç½²å®‰å…¨è§„åˆ™

### ğŸŒ ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥æ¸…å•
- [ ] âœ… ç¯å¢ƒå˜é‡å®‰å…¨é…ç½® (`env secrets management`)
- [ ] âœ… HTTPSå¼ºåˆ¶å¯ç”¨ (`SSL/TLS`)
- [ ] âœ… å®‰å…¨å¤´è®¾ç½® (`Security Headers`)
- [ ] âœ… é˜²ç«å¢™è§„åˆ™é…ç½® (`WAF rules`)
- [ ] âœ… ç›‘æ§å‘Šè­¦è®¾ç½® (`security monitoring`)
- [ ] âœ… å¤‡ä»½æ¢å¤ç­–ç•¥ (`backup strategy`)
- [ ] âœ… æ—¥å¿—æ”¶é›†åˆ†æ (`log aggregation`)

---

## ğŸ¯ å®‰å…¨å¼€å‘æ€»ç»“

### ğŸ’¡ æ ¸å¿ƒåŸåˆ™
1. **æ°¸è¿œä¸ä¿¡ä»»ç”¨æˆ·è¾“å…¥** - æ‰€æœ‰è¾“å…¥éƒ½è¦éªŒè¯
2. **API-Firstå®‰å…¨éªŒè¯** - åç«¯æ˜¯æœ€åé˜²çº¿
3. **æœ€å°æƒé™åŸåˆ™** - åªç»™å¿…éœ€çš„æƒé™
4. **æ·±åº¦é˜²å¾¡ç­–ç•¥** - å¤šå±‚å®‰å…¨éªŒè¯
5. **å¤±è´¥å®‰å…¨è®¾è®¡** - å‡ºé”™æ—¶æ‹’ç»æ“ä½œ
6. **å®Œæ•´å®¡è®¡è·Ÿè¸ª** - è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ

### ğŸš¨ å®‰å…¨çº¢çº¿
- âŒ ä»»ä½•æ–‡ä»¶ä¸Šä¼ éƒ½å¿…é¡»éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
- âŒ ä»»ä½•æ•°æ®åº“å†™æ“ä½œéƒ½å¿…é¡»éªŒè¯ç”¨æˆ·æƒé™
- âŒ ä»»ä½•ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨éƒ½å¿…é¡»æœ‰é…é¢é™åˆ¶
- âŒ ä»»ä½•ç”¨æˆ·è¾“å…¥éƒ½å¿…é¡»ç»è¿‡éªŒè¯å’Œæ¸…ç†
- âŒ ä»»ä½•é”™è¯¯ä¿¡æ¯éƒ½ä¸èƒ½æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯

### ğŸ“š æ¨èå­¦ä¹ èµ„æº
- OWASP Top 10 å®‰å…¨é£é™©
- Next.js Security Best Practices
- TypeScript Security Guidelines
- Node.js Security Checklist 